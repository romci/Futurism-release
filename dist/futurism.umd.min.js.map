{"version":3,"file":"futurism.umd.min.js","sources":["../javascript/futurism_channel.js","../javascript/elements/futurism_utils.js","../javascript/elements/futurism_element.js","../javascript/elements/futurism_table_row.js","../javascript/elements/futurism_li.js","../javascript/elements/index.js","../javascript/utils/crypto.js"],"sourcesContent":["/* global CustomEvent, setTimeout */\n\nimport CableReady from 'cable_ready'\n\nconst debounceEvents = (callback, delay = 20) => {\n  let timeoutId\n  let events = []\n  return (...args) => {\n    clearTimeout(timeoutId)\n    events = [...events, ...args]\n    timeoutId = setTimeout(() => {\n      timeoutId = null\n      callback(events)\n      events = []\n    }, delay)\n  }\n}\n\nexport const createSubscription = consumer => {\n  consumer.subscriptions.create('Futurism::Channel', {\n    connected () {\n      window.Futurism = this\n      document.addEventListener(\n        'futurism:appear',\n        debounceEvents(events => {\n          this.send({\n            signed_params: events.map(e => e.target.dataset.signedParams),\n            sgids: events.map(e => e.target.dataset.sgid),\n            signed_controllers: events.map(\n              e => e.target.dataset.signedController\n            ),\n            urls: events.map(_ => window.location.href),\n            broadcast_each: events.map(e => e.target.dataset.broadcastEach)\n          })\n        })\n      )\n    },\n\n    received (data) {\n      if (data.cableReady) {\n        CableReady.perform(data.operations, {\n          emitMissingElementWarnings: false\n        })\n\n        document.dispatchEvent(\n          new CustomEvent('futurism:appeared', {\n            bubbles: true,\n            cancelable: true\n          })\n        )\n      }\n    }\n  })\n}\n","/* global IntersectionObserver, CustomEvent, setTimeout */\n\nconst dispatchAppearEvent = (entry, observer = null) => {\n  if (!window.Futurism) {\n    return () => {\n      setTimeout(() => dispatchAppearEvent(entry, observer)(), 1)\n    }\n  }\n\n  const target = entry.target ? entry.target : entry\n\n  const evt = new CustomEvent('futurism:appear', {\n    bubbles: true,\n    detail: {\n      target,\n      observer\n    }\n  })\n\n  return () => {\n    target.dispatchEvent(evt)\n  }\n}\n\n// from https://advancedweb.hu/how-to-implement-an-exponential-backoff-retry-strategy-in-javascript/#rejection-based-retrying\nconst wait = ms => new Promise(resolve => setTimeout(resolve, ms))\n\nconst callWithRetry = async (fn, depth = 0) => {\n  try {\n    return await fn()\n  } catch (e) {\n    if (depth > 10) {\n      throw e\n    }\n    await wait(1.15 ** depth * 2000)\n\n    return callWithRetry(fn, depth + 1)\n  }\n}\n\nconst observerCallback = (entries, observer) => {\n  entries.forEach(async entry => {\n    if (!entry.isIntersecting) return\n\n    await callWithRetry(dispatchAppearEvent(entry, observer))\n  })\n}\n\nexport const extendElementWithIntersectionObserver = element => {\n  Object.assign(element, {\n    observer: new IntersectionObserver(observerCallback.bind(element), {})\n  })\n\n  if (!element.hasAttribute('keep')) {\n    element.observer.observe(element)\n  }\n}\n\nexport const extendElementWithEagerLoading = element => {\n  if (element.dataset.eager === 'true') {\n    if (element.observer) element.observer.disconnect()\n    callWithRetry(dispatchAppearEvent(element))\n  }\n}\n","/* global HTMLElement */\n\nimport {\n  extendElementWithIntersectionObserver,\n  extendElementWithEagerLoading\n} from './futurism_utils'\n\nexport default class FuturismElement extends HTMLElement {\n  connectedCallback () {\n    extendElementWithIntersectionObserver(this)\n    extendElementWithEagerLoading(this)\n  }\n}\n","/* global HTMLTableRowElement */\n\nimport {\n  extendElementWithIntersectionObserver,\n  extendElementWithEagerLoading\n} from './futurism_utils'\n\nexport default class FuturismTableRow extends HTMLTableRowElement {\n  connectedCallback () {\n    extendElementWithIntersectionObserver(this)\n    extendElementWithEagerLoading(this)\n  }\n}\n","/* global HTMLLIElement */\r\n\r\nimport {\r\n  extendElementWithIntersectionObserver,\r\n  extendElementWithEagerLoading\r\n} from './futurism_utils'\r\n\r\nexport default class FuturismLI extends HTMLLIElement {\r\n  connectedCallback () {\r\n    extendElementWithIntersectionObserver(this)\r\n    extendElementWithEagerLoading(this)\r\n  }\r\n}\r\n","/* global customElements, sessionStorage */\n\nimport FuturismElement from './futurism_element'\nimport FuturismTableRow from './futurism_table_row'\nimport FuturismLI from './futurism_li'\n\nimport { sha256 } from '../utils/crypto'\n\nconst polyfillCustomElements = () => {\n  const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent)\n\n  if (customElements) {\n    if (isSafari) {\n      document.write(\n        '<script src=\"//unpkg.com/@ungap/custom-elements-builtin\"><\\x2fscript>'\n      )\n    } else {\n      try {\n        customElements.define(\n          'built-in',\n          document.createElement('tr').constructor,\n          { extends: 'tr' }\n        )\n      } catch (_) {\n        document.write(\n          '<script src=\"//unpkg.com/@ungap/custom-elements-builtin\"><\\x2fscript>'\n        )\n      }\n    }\n  } else {\n    document.write(\n      '<script src=\"//unpkg.com/document-register-element\"><\\x2fscript>'\n    )\n  }\n}\n\nconst defineElements = e => {\n  if (!customElements.get('futurism-element')) {\n    customElements.define('futurism-element', FuturismElement)\n    customElements.define('futurism-table-row', FuturismTableRow, {\n      extends: 'tr'\n    })\n    customElements.define('futurism-li', FuturismLI, { extends: 'li' })\n  }\n}\n\nconst cachePlaceholders = e => {\n  sha256(e.detail.element.outerHTML).then(hashedContent => {\n    e.detail.element.setAttribute('keep', '')\n    sessionStorage.setItem(\n      `futurism-${hashedContent}`,\n      e.detail.element.outerHTML\n    )\n    e.target.dataset.futurismHash = hashedContent\n  })\n}\n\nconst restorePlaceholders = e => {\n  const inNamespace = ([key, _payload]) => key.startsWith('futurism-')\n  Object.entries(sessionStorage)\n    .filter(inNamespace)\n    .forEach(([key, payload]) => {\n      const match = /^futurism-(.*)/.exec(key)\n      const targetElement = document.querySelector(\n        `[data-futurism-hash=\"${match[1]}\"]`\n      )\n\n      if (targetElement) {\n        targetElement.outerHTML = payload\n        sessionStorage.removeItem(key)\n      }\n    })\n}\n\nexport const initializeElements = () => {\n  polyfillCustomElements()\n  document.addEventListener('DOMContentLoaded', defineElements)\n  document.addEventListener('turbo:load', defineElements)\n  document.addEventListener('turbo:before-cache', restorePlaceholders)\n  document.addEventListener('turbolinks:load', defineElements)\n  document.addEventListener('turbolinks:before-cache', restorePlaceholders)\n  document.addEventListener('cable-ready:after-outer-html', cachePlaceholders)\n}\n","/* global crypto */\n\nexport async function sha256 (message) {\n  // encode as UTF-8\n  const msgBuffer = new TextEncoder('utf-8').encode(message)\n\n  // hash the message\n  const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer)\n\n  // convert ArrayBuffer to Array\n  const hashArray = Array.from(new Uint8Array(hashBuffer))\n\n  // convert bytes to hex string\n  const hashHex = hashArray.map(b => ('00' + b.toString(16)).slice(-2)).join('')\n\n  return hashHex\n}\n"],"names":["dispatchAppearEvent","entry","observer","window","Futurism","setTimeout","target","evt","CustomEvent","bubbles","detail","dispatchEvent","callWithRetry","async","fn","depth","e","ms","Promise","resolve","observerCallback","entries","forEach","isIntersecting","extendElementWithIntersectionObserver","element","Object","assign","IntersectionObserver","bind","hasAttribute","observe","extendElementWithEagerLoading","dataset","eager","disconnect","FuturismElement","HTMLElement","connectedCallback","this","FuturismTableRow","HTMLTableRowElement","FuturismLI","HTMLLIElement","defineElements","customElements","get","define","extends","cachePlaceholders","message","msgBuffer","TextEncoder","encode","hashBuffer","crypto","subtle","digest","Array","from","Uint8Array","map","b","toString","slice","join","sha256","outerHTML","then","hashedContent","setAttribute","sessionStorage","setItem","futurismHash","restorePlaceholders","filter","key","_payload","startsWith","payload","match","exec","targetElement","document","querySelector","removeItem","consumer","subscriptions","create","connected","addEventListener","callback","delay","timeoutId","events","args","clearTimeout","debounceEvents","send","signed_params","signedParams","sgids","sgid","signed_controllers","signedController","urls","_","location","href","broadcast_each","broadcastEach","received","data","cableReady","CableReady","perform","operations","emitMissingElementWarnings","cancelable","isSafari","test","navigator","userAgent","write","createElement","constructor","polyfillCustomElements"],"mappings":"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"}